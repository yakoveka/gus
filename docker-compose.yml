version: "3.4"

services:
    mysql:
        image: mariadb:11.1.2
        networks:
            - gus
        volumes:
            - mysql_data:/var/lib/mysql
        environment:
            #- ALLOW_EMPTY_PASSWORD is recommended only for development.
            # ALLOW_EMPTY_PASSWORD: yes
            MYSQL_DATABASE: mydb
            MYSQL_USER: admin
            MYSQL_ROOT_PASSWORD: password
            MYSQL_PASSWORD: password
    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        ports:
            - 8080:80
        networks:
            - gus
        environment:
            PMA_HOST: mysql
        depends_on:
            - mysql
    php:
        image: ${IMAGES_PREFIX:-}app-php
        restart: unless-stopped
        volumes:
            - php_socket:/var/run/php
        healthcheck:
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 30s
        networks:
            - gus
        environment:
            TRUSTED_PROXIES: ${TRUSTED_PROXIES:-127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16}
            TRUSTED_HOSTS: ^${SERVER_NAME:-example\.com|localhost}|caddy$$
            # The two next lines can be removed after initial installation
            SYMFONY_VERSION: ${SYMFONY_VERSION:-}
            STABILITY: ${STABILITY:-stable}
            # Run "composer require symfony/orm-pack" to install and configure Doctrine ORM
            DATABASE_URL: mysql
            # Run "composer require symfony/mercure-bundle" to install and configure the Mercure integration

    nginx:
        image: nginx:latest
        volumes:
            - './nginx-conf:/etc/nginx/conf.d'
            - phpmyadmin_data:/var/www/html/:ro
        ports:
            - "80:80"
        links:
            - 'php'
        networks:
            - gus
        depends_on:
            - php

# Mercure is installed as a Caddy module, prevent the Flex recipe from installing another service
###> symfony/mercure-bundle ###
###< symfony/mercure-bundle ###

volumes:
    php_socket:
    mysql_data:
    phpmyadmin_data:

networks:
    gus:
###> symfony/mercure-bundle ###
###< symfony/mercure-bundle ###